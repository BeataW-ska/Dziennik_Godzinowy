<!DOCTYPE html>
<html lang="pl">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Dziennik</title>
 <meta name="theme-color" content="#1c1c1c">
 <link rel="manifest" href="manifest.json">

 <style>
 body {
 background: #1c1c1c;
 color: #ffffff;
 font-family: sans-serif;
 margin: 0;
 padding: 0;
 }

 header {
 display: flex;
 flex-wrap: wrap;
 gap: 6px;
 background: #222;
 padding: 10px;
 position: sticky;
 top: 0;
 }

footer {
 padding: 10px;
 background: #222;
 border-bottom: 1px solid #444;
 }

 button {
 background: #333;
 color: #fff;
 border: 1px solid #555;
 padding: 5px 10px;
 margin: 2px;
 border-radius: 4px;
 }
 input[type="text"], input[type="range"] {
 accent-color: gray;
 background: #333;
 color: #fff;
 border: 1px solid #555;
 padding: 4px;
 border-radius: 4px;
 width: 100%;
 }
 .hour-card {
 background: #2a2a2a;
 border: 1px solid #444;
 padding: 10px;
 margin: 8px;
 border-radius: 6px;
 }
 .hour-title {
 display: flex;
 justify-content: space-between;
 align-items: center;
 }
 .pill {
 background: #444;
 padding: 2px 6px;
 border-radius: 4px;
 }
 .label {
 font-size: 0.9em;
 display: block;
 margin-bottom: 2px;
 }
 .value-badge {
 font-size: 0.8em;
 color: #aaa;
 margin-left: 6px;
 }
 .form-row {
  display: grid;
  grid-template-columns: 1fr 2fr; /* 1/3 + 2/3 */
  align-items: center;
  gap: 10px;
  margin-bottom: 6px;
}

.form-row label {
  margin: 0; 
  font-size: 0.95em;
}

.form-row input[type="range"],
.form-row input[type="text"],
.form-row textarea {
  width: 100%;
}
 </style>
</head>



<body>
 <header>
 <button id="prevDate">◀︎</button>
 <input type="date" id="datePicker">
 <button id="nextDate">▶︎</button>
 <button id="fillEmpty">Wypełnij luki</button>
 <button id="copyPrev">Skopiuj poprzednią</button>
 <button id="clearDay">Wyczyść dzień</button>
 <button id="exportCsv">Eksport CSV</button>
 <button id="backupJson">Backup</button>
 <button id="restoreJson">Przywróć</button>
 <input type="file" id="restoreInput" style="display:none">
 </header>

 <!-- tu będą wstawiane godziny -->
 <main id="hoursContainer"></main>

 <footer>
 <small>Dziennik Godzinowy – dane zapisywane w Twojej przeglądarce</small>
 </footer>

 <!-- Twój duży skrypt -->
 <script>
 // --- Helpers ---
 const HOURS = Array.from({length: 16}, (_,i) => i + 8); // 8..23
 const $ = sel => document.querySelector(sel);
 const pad2 = n => String(n).padStart(2,'0');
 const todayStr = () => new Date().toISOString().slice(0,10);
 const safeId = s => s.replace(/:/g, '-'); //"08:00" -> "08-00"

 // Simple storage layer
 const KEY = 'dziennik-v1';
 const loadAll = () => JSON.parse(localStorage.getItem(KEY) || '{}');
 const saveAll = (data) => localStorage.setItem(KEY, JSON.stringify(data));

 function defaultDay(dateStr) {
 const obj = {};
 for (const h of HOURS) {
 obj[pad2(h)+':00'] = { activity:'', mood:null, pleasure:null, satisfaction:null, comment:'' };
 }
 return { date: dateStr, entries: obj };
 }

 function getDay(dateStr) {
 const db = loadAll();
 if (!db[dateStr]) db[dateStr] = defaultDay(dateStr);
 return db[dateStr];
 }

 function setDay(dayObj) {
 const db = loadAll();
 db[dayObj.date] = dayObj;
 saveAll(db);
 }

 // Build UI
 const container = $('#hoursContainer');

 function inputNumberRow(id, labelText, min, max, value) {
 const wrap = document.createElement('div');
 wrap.innerHTML = `
 <label for="${id}">${labelText} <span class="value-badge" id="${id}-val">${value ?? ''}</span></label>
 <input id="${id}" type="range" min="${min}" max="${max}" step="1" value="${value ?? Math.floor((min+max)/2)}">
 `;
 return wrap;
 }

function hourCard(hour, entry, prevEntry) {
 const hStr = pad2(hour)+':00'; // wartość logiczna klucza
 const sid = safeId(hStr); // wersja bez dwukropka do ID

 const card = document.createElement('section');
 card.className = 'hour-card';
 card.dataset.hour = hStr;

 card.innerHTML = `
 <div class="hour-title">
 <div><strong>${hStr}</strong></div>
 </div>
 <div class="grid" style="margin-top:5px">

 <div class="form-row">
 <label for="aktywnosc">Aktywność</label>
 <input type="text" id="act-${sid}" placeholder="np. spacer, obiad" value="${entry.activity ?? ''}">
 </div>

 <div class="form-row">
 <label for="komentarz">Komentarz</label>
 <input type="text" id="com-${sid}" placeholder="opcjonalnie" value="${entry.comment ?? ''}">
 </div>
 
 <div class="form-row" style="margin-top:4px" id="mood-${sid}"></div>
 <div class="grid" style="margin-top:4px" id="pleasure-${sid}"></div>
 <div class="grid" style="margin-top:4px">
 <div id="satisfaction-${sid}"></div>
 
 </div>
 `;

 // Insert range inputs (ID już bez dwukropka)
 const moodWrap = card.querySelector(`#mood-${sid}`);
 const pleasureWrap = card.querySelector(`#pleasure-${sid}`);
 const satisfactionWrap = card.querySelector(`#satisfaction-${sid}`);

 moodWrap.appendChild(inputNumberRow(`mood-${sid}-range`, 'Nastrój (0–10)', 0, 10, entry.mood));
 pleasureWrap.appendChild(inputNumberRow(`pleasure-${sid}-range`, 'Przyjemność (0–10)', 0, 10, entry.pleasure));
 satisfactionWrap.appendChild(inputNumberRow(`satisfaction-${sid}-range`, 'Satysfakcja (0–10)', 0, 10, entry.satisfaction));

 // Bind changes
 const act = card.querySelector(`#act-${sid}`);
 const com = card.querySelector(`#com-${sid}`);
 const mood = card.querySelector(`#mood-${sid}-range`);
 const pleasure = card.querySelector(`#pleasure-${sid}-range`);
 const satisfaction = card.querySelector(`#satisfaction-${sid}-range`);
 const pill = card.querySelector('.pill');

 function save() {
 const dateStr = $('#datePicker').value;
 const day = getDay(dateStr);
 day.entries[hStr] = {
 activity: act.value.trim(),
 mood: Number(mood.value),
 pleasure: Number(pleasure.value),
 satisfaction: Number(satisfaction.value),
 comment: com.value.trim()
 };
 setDay(day);
 pill.textContent = act.value.trim() || '— brak aktywności —';
 }

 for (const el of [act, com, mood, pleasure, satisfaction]) {
 el.addEventListener('change', save);
 el.addEventListener('input', (e) => {
 const span = card.querySelector(`#${e.target.id}-val`);
 if (span) span.textContent = e.target.value;
 });
 }

 // Quick mood buttons
 card.querySelectorAll('.quick').forEach(btn => {
 btn.addEventListener('click', () => {
 const v = btn.dataset.val;
 mood.value = v;
 card.querySelector(`#${mood.id}-val`).textContent = v;
 save();
 });
 });

 return card;
}
 function renderDay(dateStr) {
 const day = getDay(dateStr);
 container.innerHTML = '';
 let prev = null;
 for (const h of HOURS) {
 const entry = day.entries[pad2(h)+':00'];
 const card = hourCard(h, entry, prev);
 container.appendChild(card);
 prev = entry;
 }
 // Scroll to current hour if same date
 const today = todayStr();
 if (dateStr === today) {
 const now = new Date();
 const h = now.getHours();
 const target = container.querySelector(`[data-hour="${pad2(Math.max(8, Math.min(23,h)))}:00"]`);
 if (target) target.scrollIntoView({behavior:'smooth', block:'start'});
 }
 }

 function setDateInput(val) {
 $('#datePicker').value = val;
 }

 function shiftDate(days) {
 const d = new Date($('#datePicker').value);
 d.setDate(d.getDate()+days);
 const v = d.toISOString().slice(0,10);
 setDateInput(v);
 renderDay(v);
 }

 // Toolbar actions
 $('#exportCsv').addEventListener('click', () => {
 const db = loadAll();
 const rows = [['Data','Godzina','Aktywność','Nastrój','Przyjemność','Satysfakcja','Komentarz']];
 const dates = Object.keys(db).sort();
 dates.forEach(date => {
 const entries = db[date].entries;
 Object.keys(entries).forEach(hour => {
 const e = entries[hour];
 rows.push([date, hour, e.activity ?? '', e.mood ?? '', e.pleasure ?? '', e.satisfaction ?? '', (e.comment ?? '').replace(/\n/g,' ')]);
 });
 });
 const csv = rows.map(r => r.map(x => `"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
 const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
 const a = document.createElement('a');
 a.href = URL.createObjectURL(blob);
 a.download = 'dziennik.csv';
 a.click();
 });

 $('#backupJson').addEventListener('click', () => {
 const blob = new Blob([localStorage.getItem(KEY) || '{}'], {type:'application/json'});
 const a = document.createElement('a');
 a.href = URL.createObjectURL(blob);
 a.download = 'dziennik-backup.json';
 a.click();
 });

 $('#restoreJson').addEventListener('click', () => $('#restoreInput').click());
 $('#restoreInput').addEventListener('change', (e) => {
 const file = e.target.files[0];
 if (!file) return;
 const reader = new FileReader();
 reader.onload = () => {
 try {
 const obj = JSON.parse(reader.result);
 if (typeof obj !== 'object') throw new Error('Invalid JSON');
 saveAll(obj);
 renderDay($('#datePicker').value);
 alert('Przywrócono dane.');
 } catch(err) {
 alert('Błąd przywracania: ' + err.message);
 }
 };
 reader.readAsText(file);
 });

 $('#fillEmpty').addEventListener('click', () => {
 const dateStr = $('#datePicker').value;
 const day = getDay(dateStr);
 let last = null;
 for (const h of HOURS) {
 const key = pad2(h)+':00';
 const e = day.entries[key];
 if (e.activity || e.comment || e.mood !== null || e.pleasure !== null || e.satisfaction !== null) {
 last = e;
 } else if (last) {
 day.entries[key] = {...last}; // copy previous non-empty
 }
 }
 setDay(day);
 renderDay(dateStr);
 });

 $('#copyPrev').addEventListener('click', () => {
 // copy previous hour into the hour currently in view (best-effort: use first visible card)
 const cards = [...document.querySelectorAll('.hour-card')];
 const rects = cards.map(c => [c, c.getBoundingClientRect().top]);
 rects.sort((a,b) => Math.abs(a[1]) - Math.abs(b[1]));
 const current = rects[0]?.[0];
 if (!current) return;
 const hourStr = current.dataset.hour;
 const h = parseInt(hourStr.slice(0,2),10);
 const prevH = Math.max(8, h-1);
 const dateStr = $('#datePicker').value;
 const day = getDay(dateStr);
 const prev = day.entries[pad2(prevH)+':00'];
 day.entries[hourStr] = {...prev};
 setDay(day);
 renderDay(dateStr);
 });

 $('#clearDay').addEventListener('click', () => {
 const dateStr = $('#datePicker').value;
 if (!confirm('Na pewno wyczyścić wszystkie wpisy dla ' + dateStr + '?')) return;
 const day = defaultDay(dateStr);
 setDay(day);
 renderDay(dateStr);
 });

 // Date picker init and nav
 $('#prevDate').addEventListener('click', () => shiftDate(-1));
 $('#nextDate').addEventListener('click', () => shiftDate(+1));

 // Init app
 window.addEventListener('load', () => {
 const d = todayStr();
 setDateInput(d);
 renderDay(d);

 // Register service worker
 if ('serviceWorker' in navigator) {
 navigator.serviceWorker.register('service-worker.js');
 }
 });
 </script>
</body>
</html>